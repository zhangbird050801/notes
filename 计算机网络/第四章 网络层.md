
## 网络层服务
- 在发送主机和接收主机对之间传送段（segment） 
- 在发送端将段封装到数据报中 
- 在接收端，将段上交给传输层实体 
- 网络层协议存在于每一个主机和路由器 
- 路由器检查每一个经过它的 IP 数据报的头部

## 网络层的关键功能
- 转发: 将分组从路由器的输入接口转发到合适的输出接口 (类似于旅行中通过单个路口的过程)
- 路由: 使用路由算法来决定分组从发送主机到目标接收主机的路径 (从源到目的的路由路径规划过程) 
	- 路由选择算法 
	- 路由选择协议

路由是一个控制平面的功能(全局的功能)，而转发是一个数据平面的功能(局部的功能)。
IP 协议实现了数据层面的转发功能，路由选择实体实现了控制平面的路由功能，控制平面的结果体现在路由表，路由表交给 IP 协议，IP 协议用路由表对到来的分组做转发。也就是说路由表是控制平面和数据平面的一个粘合剂。控制平面的路由功能算出来路由表，路由表交给 IP 协议，IP 协议拿到路由表对到来的分组做局部的转发，实现数据平面的功能。

## 数据平面和控制平面 
### 数据平面
- 本地，每个路由器功能
- 决定从路由器输入端口到达的分组如何转发到输出端口
- 转发功能：
	- 传统方式：基于目标地址 + 转发表
	- SDN 方式：基于多个字段 + 流表

### 控制平面
- 网络范围内的逻辑
- 决定数据报如何在路由器之间路由，决定数据报从源到目标主机之间的端到端路径
- 2 个控制平面方法:
	- 传统的路由算法: 在路由器中被实现
	- software-defined networking (SDN) 软件定义网络: 在远程的服务器中实现

### 传统方式
控制平面算出路由表，数据平面对到来的分组按照路由表进行转发。
![|550](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250211185605392.png)

### SDN 方式：逻辑集中的控制平面
![|550](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250211185958401.png)

## 网络服务模型
- 对于单个数据报的服务: 
	- 可靠传送 
	- 延迟保证，如：少于 40ms 的延迟
- 对于数据报流的服务: 
	- 保序数据报传送 
	- 保证流的最小带宽 
	- 分组之间的延迟差

### 连接建立
在分组传输之前，在两个主机之间，在通过一些路由器所构成的路径上建立一个网络层连接(涉及到路由器)
<br>

网络层和传输层连接服务区别: 
- 网络层: 在 2 个主机之间，涉及到路径上的一些路由器 -> 有连接
- 传输层:在 2 个进程之间，很可能只体现在端系统上 (TCP 连接) -> 面向连接

## 路由器
### 路由器结构
- 路由：运行路由选择算法／协议(RIP, OSPF, BGP)。生成 路由表 
- 转发：从输入到输出链路交换数据报-根据路由表进行分组的转发
![|400](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250211194851879.png)






## IP: Internet Protocol




### IPv4 地址
- IP 地址: 32 位标示，对主机或者路由器的接口编址 
- 接口: 主机/路由器和物理链路的连接处 
	- 路由器通常拥有多个接口 
	- 主机也有可能有多个接口 
	- IP 地址和每一个接口关联 
	- 一个 IP 地址和一个接口相关联



### IP 地址分类
![|500](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250212145750154.png)

全 1 和全 0 的不可以。

|     | 网络    | 主机    |
| --- | --- | --- |
| A    |  $2^7-2=126$   | $2^{24}-2$    |
| B    | $2^{14}-2$    | $2^{16}-2$  |
| C    |     | $2^8-2=254$    |
| D    |     |     |
| E    |     |     |

### 特殊 IP 地址
- 子网部分: 全为 0 --- 本网络 
- 主机部分: 全为 0 --- 本主机 
- 主机部分: 全为 1 --- 广播地址，这个网络的所有主机

![|700](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250212154040080.png)

### 内网(专用) IP 地址
- 专用地址：地址空间的一部份供专用地址使用 
- 永远不会被当做公用地址来分配, 不会与公用地址重复。只在局部网络中有意义，区分不同的设备 
- 路由器不对目标地址是专用地址的分组进行转发 
- 专用地址范围:
	- Class A: 10.0.0.0 - 10.255.255.255 MASK 255.0.0.0
	- Class B: 172.16.0.0 - 172.31.255.255 MASK 255.255.0.0
	- Class C: 192.168.0.0 - 192.168.255.255 MASK 255.255.255.0

### CIDR 无分类域间路由选择
![|550](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250212161139078.png)

### 子网掩码 subnet mask
- 32 bits , 0 or 1 in each bit 
	- 1: bit 位置表示子网部分 
	- 0: bit 位置表示主机部分 
- 原始的 A、B、C 类网络的子网掩码分别是
	- A：255.0.0.0 ：11111111 00000000 0000000 00000000 
	- B：255.255.0.0：11111111 11111111 0000000 00000000 
	- C：255.255.255.0：11111111 11111111 11111111 00000000 
- CIDR 下的子网掩码例子： 
	- 11111111 11111111 11111100 00000000 
- 另外的一种表示子网掩码的表达方式 
	- /# 
	- 例：/22：表示前面 22 个 bit 为子网部分

### DHCP 
Dynamic Host Configuration Protocol
从服务器中动态获得一个 IP 地址。
- 目标: 允许主机在加入网络的时候，动态地从服务器那里获得IP地址
	- 可以更新对主机在用 IP 地址的租用期 - 租期快到了
	- 重新启动时，允许重新使用以前用过的 IP 地址 
	- 支持移动用户加入到该网络（短期在网）
- DHCP 工作概况: 
	- 主机广播 “DHCP discover” 报文\[可选] 
	- DHCP 服务器用 “DHCP offer” 提供报文响应\[可选] 
	- 主机请求 IP 地址：发送 “DHCP request” 报文 
	- DHCP 服务器发送地址：“DHCP ack” 报文

### NAT 
Network Address Translation 网络地址转换

简单来说就是出去的时候将内网地址转换为机构统一的 IP 地址，当然要记住原来的地址。回来的时候再由这个 IP 地址转换为内网地址。
![|550](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250214010922667.png)

![|550](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250214010959487.png)

### IPv6
初始动机: 32-bit 地址空间将会被很快用完
IPv4 长度 32 bit
IPv6 长度 128 bit
#### IPv6 数据报格式:
- 固定的 40 字节头部 
- 数据报传输过程中，不允许分片

#### IPv6 头部
![|575](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250214011529803.png)

#### 相较于 IPv4 的一些变化
- Checksum: 被移除掉，降低在每一段中的处理速度 
- Options: 允许，但是在头部之外, 被 “Next Header” 字段标示 
- ICMPv6: ICMP 的新版本 
- 附加了报文类型, e.g. “Packet Too Big” 
- 多播组管理功能

## 通用转发和 SDN
### SDN 主要思路
- 网络设备数据平面和控制平面分离 
- 数据平面 - 分组交换机 
	- 将路由器、交换机和目前大多数网络设备的功能进一步抽象成：按照流表（由控制平面设置的控制逻辑）进行 PDU（帧、分组）的动作（包括转发、丢弃、拷贝、泛洪、阻塞） 
	- 统一化设备功能：SDN 交换机（分组交换机），执行控制 逻辑 
- 控制平面 - 控制器 + 网络应用 
	- 分离、集中 
	- 计算和下发控制逻辑：流表


## 路由
- 路由: 按照某种指标(传输延迟,所经过的站点数目等)找到一条从源节点到目标节点的较好路径
	- 较好路径: 按照某种指标较小的路径
	- 指标: 站数, 延迟, 费用, 队列长度等, 或者是一些单纯指标的加权平均
	- 采用什么样的指标, 表示网络使用者希望网络在什么方面表现突出, 什么指标网络使用者比较重视
- 以网络为单位进行路由（路由信息通告 + 路由计算）
	- 网络为单位进行路由，路由信息传输、计算和匹配的代价低 
	- 前提条件是：一个网络所有节点地址前缀相同，且物理上聚集 
	- 路由就是：计算网络到其他网络如何走的问题
- 网络到网络的路由 = 路由器-路由器之间路由 
	- 网络对应的路由器到其他网络对应的路由器的路由 
	- 在一个网络中：路由器-主机之间的通信，链路层解决 
	- 到了这个路由器就是到了这个网络

网络的图抽象：
![|550](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250214171149111.png)

路由的输入：拓扑、边的代价、源节点
最后形成一个汇集树。
![|500](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250214183821392.png)

### 路由选择算法的原则
- 正确性(correctness): 算法必须是正确的和完整的,使分组一站一站接力，正确发向目标站；完整：目标所有的站地址，在路由表中都能找到相应的表项；没有处理不了的目标站地址；
- 简单性(simplicity): 算法在计算机上应简单：最优但复杂的算法，时间上延迟很大，不实用，不应为了获取路由信息增加很多的通信量；
- 健壮性(robustness): 算法应能适应通信量和网络拓扑的变化：通信量变化，网络拓扑的变化算法能很快适应；不向很拥挤的链路发数据，不向断了的链路发送数据；
- 稳定性(stability)：产生的路由不应该摇摆 
- 公平性(fairness)：对每一个站点都公平 
- 最优性(optimality)：某一个指标的最优，时间上，费用上，等指标，或综合指标；实际上，获取最优的结果代价较高，可以是**次优**的

### 路由算法分类
![|625](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250214184027101.png)

### link state 路由算法
