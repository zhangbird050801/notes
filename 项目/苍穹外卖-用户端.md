---
tags:
  - JavaWeb
  - 项目
---
管理端见[[苍穹外卖-管理端]]


小程序主体

|    文件    | 必须  |    作用    |
| :------: | :-: | :------: |
|  app.js  |  是  |  小程序逻辑   |
| app.json |  是  | 小程序公共配置  |
| app.wxss |  否  | 小程序公共样式表 |

小程序页面
一个小程序页面由四个文件组成

| 文件类型 | 必需  | 作用    |
| ---- | --- | ----- |
| js   | 是   | 页面逻辑  |
| wxml | 是   | 页面结构  |
| json | 否   | 页面配置  |
| wxss | 否   | 页面样式表 |

`app.json` 中的页面配置，像 `/pages/index/index` 就是对应 `pages/index/index/wxml`
![](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250403203620593.png)

## 微信登录
- 基于微信登录实现小程序的登录功能
- 如果是新用户需要自动完成注册

配置文件配置好 user-secret-key，userTtl 和 user-token-name 以及微信小程序的 app-id 和 app-secret
```yml
sky:  
  jwt:  
    # 设置jwt签名加密时使用的秘钥  
    admin-secret-key: itcast  
    # 设置jwt过期时间  
    admin-ttl: 7200000  
    # 设置前端传递过来的令牌名称  
    admin-token-name: token  
    user-secret-key: itheima  
    userTtl: 7200000  
    user-token-name: authentication
    
wechat:  
  app-id: ${sky.wechat.app-id}  
  app-secret: ${sky.wechat.app-secret}
```

再在 `application-dev.yml` 文件里配置好 app-id 和 app-secret。
前端传过来的数据用 UserLoginDTO 进行封装。
```java
@Data  
public class UserLoginDTO implements Serializable {  
    private String code;  
}
```

VO 对象：
```java
public class UserLoginVO implements Serializable {  
    private Long id;  
    private String openid;  
    private String token;  
}
```



拦截器
```java
public class JwtTokenUserInterceptor implements HandlerInterceptor {  
  
    @Autowired  
    private JwtProperties jwtProperties;  
  
    /**  
     * 校验jwt  
     * @param request  
     * @param response  
     * @param handler  
     * @return  
     * @throws Exception  
     */  
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {  
        //判断当前拦截到的是Controller的方法还是其他资源  
        if (!(handler instanceof HandlerMethod)) {  
            //当前拦截到的不是动态方法，直接放行  
            return true;  
        }  
        //1、从请求头中获取令牌  
        String token = request.getHeader(jwtProperties.getUserTokenName());  
  
        //2、校验令牌  
        try {  
            log.info("jwt校验:{}", token);  
            Claims claims = JwtUtil.parseJWT(jwtProperties.getUserSecretKey(), token);  
            Long userId = Long.valueOf(claims.get(JwtClaimsConstant.USER_ID).toString());  
  
            BaseContext.setCurrentId(userId);  
            //3、通过，放行  
            return true;  
        } catch (Exception ex) {  
            //4、不通过，响应401状态码  
            response.setStatus(401);  
            return false;  
        }    }}
```

拦截器注册
`WebMvcConfiguration` 中加入：
```java
@Autowired  
private JwtTokenUserInterceptor jwtTokenUserInterceptor;  
  
/**  
 * 注册自定义拦截器  
 *  
 * @param registry  
 */  
protected void addInterceptors(InterceptorRegistry registry) {  	
    registry.addInterceptor(jwtTokenUserInterceptor)  
            .addPathPatterns("/user/**")  
            .excludePathPatterns("/user/user/login")  
            .excludePathPatterns("/user/shop/status");  
}
```