
## 项目结构

| 名称     | 说明                                  |
| ------ | ----------------------------------- |
| Entity | 实体，与数据库中的表对应                        |
| DTO    | 数据传输对象，通常用于程序中各层之间传递数据              |
| VO     | 视图对象，为前端展示数据提供的对象                   |
| POJO   | 普通 Java 对象，只有属性和对应的 getter 和 setter |

前后端联调
![|950](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217121652581.png)

项目大致结构
![|175](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217124105567.png)

异常放在 sky-common 下的 exception 包中
![|400](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217131958971.png)

而在 sky-server 的 handler 包下配置了全局异常处理器。
![|925](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217132046903.png)

`application-dev.yml` 文件配置数据库用户名和密码。
![|1050](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217124219778.png)

前端 nginx 启动，端口在 80。后端启动，端口在 8080。

访问 `localhost` 会跳转到 `http://localhost/#/login`
![|675](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217124453391.png)

管理员账号密码存储在数据库 `employee` 表下。此时存储在数据库中的密码并没有加密。
![|825](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217124603747.png)

## 登录
![|725](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217130623847.png)

![|900](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217130726161.png)

之后步过这一步，进入 login 方法打个断点。
![|775](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217130955250.png)

可以看到前端发送的请求为：
![|600](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217130901073.png)

login 的具体实现:
![|1000](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217131104263.png)
这里面是用到了 mapper 调查数据库中的对象。
![|900](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217131403468.png)
简单的数据库语句使用注解的方式，复杂的 sql 用 xml。
```java
@Select("select * from employee where username = #{username}")
```

mapper 层查找到这个用户返回给 service 层，然后再比对用户密码、判断账户是否被锁定，核验成功后 service 层再把对象返回给 controller 层。
![|1050](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217131214421.png)

生成 jwt 令牌，参数通过 `jwtProperties` 传入。
![|925](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217132457328.png)

`jwtProperties` 中的属性在配置文件中可以找到。
![|925](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217132710945.png)

最后数据封装成 VO 对象，放在 Result 里面响应给前端页面。
![|875](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217132858819.png)

`EmployeeLoginVO` 包括 id、用户名、姓名、jwt 令牌。 这里构造对象用的 `builder()` 方法，使用这个方法必须要在 VO 对象上加入注解 `@Builder`
![|500](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217132958874.png)

## 前后端如何交互
从刚才登录的例子可以看到，前端发送的请求地址 `/api/employee/login`。但是后端 Controller 中定义的请求地址是 `/admin/employee/login`。与此同时，前端是 `localhost` 或者 `localhost:80`，但是后端是 `localhost:8080`。那么前端发送的请求到底是如何传给后端的呢？
```java
@RequestMapping("/admin/employee")
```

=> 通过 nginx 反向代理
![|800](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217134125060.png)
![|800](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217134322303.png)
使用 nginx 反向代理，可以保证提高访问速度、进行负载均衡(把大量的请求按照我们指定的方式均衡的分配给集群中的每台服务器)、保证后端服务的安全。

在 nginx 的配置文件中可以配置反向代理：
![|575](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217134849548.png)

```conf
server {
	listen       80;
	server_name  localhost;

	# 反向代理,处理管理端发送的请求
	location /api/ {
		proxy_pass   http://localhost:8080/admin/;
		#proxy_pass   http://webservers/admin/;
	}
}
```

![|900](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217135027834.png)

## 完善登录功能
由于前面看到，密码存储在数据库中是以明文的方式，安全系数低。我们可以用 MD5 加密，让存储在数据库中的密码是加密后的密码，但是有一个问题就是，前端用户输入还是原来明文的密码，所以我们在登录检验的过程中要把用户输入的密码转换成 MD5 加密后的密码，然后再和数据库中的密码进行比对。
不过，原先存储在数据库中的用户密码我们需要改成 MD5 加密，这里手动修改一下就行。
![|575](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217145350460.png)

将 `EmployeeServiceImpl.java` 中的这段代码
```java
// TODO 后期需要进行md5加密，然后再进行比对  
if (!password.equals(employee.getPassword())) {  
    //密码错误  
    throw new PasswordErrorException(MessageConstant.PASSWORD_ERROR);  
}  
  
if (employee.getStatus() == StatusConstant.DISABLE) {  
    //账号被锁定  
    throw new AccountLockedException(MessageConstant.ACCOUNT_LOCKED);  
}
```
改为
```java
password = DigestUtils.md5DigestAsHex(password.getBytes());  
if (!password.equals(employee.getPassword())) {  
    //密码错误  
    throw new PasswordErrorException(MessageConstant.PASSWORD_ERROR);  
}  
  
if (employee.getStatus() == StatusConstant.DISABLE) {  
    //账号被锁定  
    throw new AccountLockedException(MessageConstant.ACCOUNT_LOCKED);  
}
```

## 接口
使用 apifox 导入，选择数据格式为 `YApi`
![|850](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217154903580.png)

![|850](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217155051341.png)

最后导入完两个项目大概是这样：
![|1175](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217155228468.png)

- 本项目规定
	- 管理端发出的请求，统一使用 `/admin` 作为前缀
	- 用户端发出的请求，统一使用 `/user` 作为前缀
### Swagger
用 Swagger 帮助后端生成接口文档，并且可以进行后端的接口测试。导入 knife4j 来使用，不过项目里已经为我们导入好了
```xml
<dependency>  
    <groupId>com.github.xiaoymin</groupId>  
    <artifactId>knife4j-spring-boot-starter</artifactId>  
    <version>3.0.2</version>  
</dependency>
```

配置文件位于 `sky-take-out/sky-server/src/main/java/com/sky/config/WebMvcConfiguration.java`
```java
@Configuration  
@Slf4j  
public class WebMvcConfiguration extends WebMvcConfigurationSupport {  
  
    @Autowired  
    private JwtTokenAdminInterceptor jwtTokenAdminInterceptor;  
  
    /**  
     * 注册自定义拦截器  
     *  
     * @param registry  
     */  
    protected void addInterceptors(InterceptorRegistry registry) {  
        log.info("开始注册自定义拦截器...");  
        registry.addInterceptor(jwtTokenAdminInterceptor)  
                .addPathPatterns("/admin/**")  
                .excludePathPatterns("/admin/employee/login");  
    }  
  
    /**  
     * 通过knife4j生成接口文档  
     * @return  
     */  
    @Bean  
    public Docket docket() {  
        ApiInfo apiInfo = new ApiInfoBuilder()  
                .title("苍穹外卖项目接口文档")  
                .version("2.0")  
                .description("苍穹外卖项目接口文档")  
                .build();  
        Docket docket = new Docket(DocumentationType.SWAGGER_2)  
                .apiInfo(apiInfo)  
                .select()  
                .apis(RequestHandlerSelectors.basePackage("com.sky.controller"))  
                .paths(PathSelectors.any())  
                .build();  
        return docket;  
    }  
  
    /**  
     * 设置静态资源映射  
     * @param registry  
     */  
    protected void addResourceHandlers(ResourceHandlerRegistry registry) {  
        registry.addResourceHandler("/doc.html").addResourceLocations("classpath:/META-INF/resources/");  
        registry.addResourceHandler("/webjars/**").addResourceLocations("classpath:/META-INF/resources/webjars/");  
    }  
}
```

其中，这句话指定了扫描的包：
```java
.apis(RequestHandlerSelectors.basePackage("com.sky.controller"))  
```

{% link 接口文档, swagger , http://localhost:8080/doc.html#/home %}

![|950](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217160312254.png)

如果配置的时候没有写静态资源映射，SpringMVC 会认为请求的不是静态资源，而是一个动态请求，会请求某个 controller，所以访问界面会报 404。

Swagger 常用注解:

|                   |                            |
| ----------------- | -------------------------- |
| @Api              | 用在类上，例如 Controller，表示对类的说明 |
| @ApiModel         | 用在类上，例如 entity、DTO、VO      |
| @ApiModelProperty | 用在属性上，描述属性信息               |
| @ApiOperation     | 用在方法上，说明方法的用途、作用           |

```java
@Api(tags = "员工相关接口")  
public class EmployeeController {
}
```

```java
@ApiOperation(value = "员工登录")  // 也可以省略 value
public Result<EmployeeLoginVO> login(@RequestBody EmployeeLoginDTO employeeLoginDTO) {
}
```

之后重新启动项目进入文档，可以看到这边名字都变成刚才指定的了。
![|325](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217164935857.png)

## 员工模块
### 新增员工
#### 需求分析
![|625](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217172526210.png)
#### 数据表分析
对于 `employee` 表:
![|750](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217172431504.png)

可以看到 `username` 是唯一的，然后 `id` 是自增的。
![|350](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217172700183.png)

#### DTO 设计
当前端提交的数据和实体类中对应的属性差别较大的时候，建议用 DTO 来封装数据。
![|675](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217182333234.png)

`sky-take-out/sky-pojo/src/main/java/com/sky/dto/EmployeeDTO.java`
```java
@Data  
public class EmployeeDTO implements Serializable {  
  
    private Long id;  
  
    private String username;  
  
    private String name;  
  
    private String phone;  
  
    private String sex;  
  
    private String idNumber;  
  
}
```
#### Controller 层
提交过来的数据是 `json` 格式的，需要在参数前面加上 `@RequestBody` 
```java
@PostMapping  
@ApiOperation("新增员工")  
public Result save(@RequestBody EmployeeDTO employeeDTO) {  
    log.info("新增员工，员工信息：{}", employeeDTO);  
    employeeService.save(employeeDTO);  
    return Result.success();  
}
```
#### Service 层
传过来的是一个 DTO 对象，但是由于这个 DTO 中只有部分属性，后续用到还可能有别的属性，存到数据库中还是用原来的 Employee 比较好。通过对象属性拷贝，可以将 DTO 对象中的属性复制到实体类的对应属性。其余的一些属性需要我们手动设置，不过这里留个坑先，先固定写死创建用户和修改用户，后期进行完善。
```java
@Override  
public void save(EmployeeDTO employeeDTO) {  
    Employee employee = new Employee();  
  
    // 属性拷贝  
    BeanUtils.copyProperties(employeeDTO, employee);  
  
    // 设置账户属性，ENABLE 为启用  
    employee.setStatus(StatusConstant.ENABLE);  
  
    // 设置密码，默认为 123456(存储在 PasswordConstant 里的 DEFAULT_PASSWORD)，同时用 MD5 进行加密  
    employee.setPassword(DigestUtils.md5DigestAsHex(PasswordConstant.DEFAULT_PASSWORD.getBytes()));  
  
    // 设置创建时间和修改时间  
    employee.setCreateTime(LocalDateTime.now());  
    employee.setUpdateTime(LocalDateTime.now());  
  
    // 设置创建人 ID 和修改人 ID    
    // TODO: 后期需要改为当前登录用户的 ID    
    employee.setCreateUser(10L);  
    employee.setUpdateUser(10L);  
  
    // 调用 mapper    
    employeeMapper.insert(employee);  
}
```
#### Mapper 层
由于在项目配置文件中开启了驼峰命名，属性中，比如 createTime 可以转换为 create_time
![|575](https://typora-birdy.oss-cn-guangzhou.aliyuncs.com/20250217185801142.png)

```java
@Insert("insert into employee (name, username, password, phone, sex, id_number, status, create_time, update_time, create_user, update_user) " +  
        "values " +  
        "(#{name}, #{username}, #{password}, #{phone}, #{sex}, #{idNumber}, #{status}, #{createTime}, #{updateTime}, #{createUser}, #{updateUser})")  
void insert(Employee employee);
```
### 员工分页查询


### 启用禁用员工账号


### 编辑员工

